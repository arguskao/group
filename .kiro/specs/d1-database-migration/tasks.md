# 實作計畫

- [-] 1. 設定 Cloudflare D1 資料庫和 Worker 專案結構
  - 建立 Cloudflare Worker 專案目錄結構
  - 設定 wrangler.toml 配置檔案
  - 建立 D1 資料庫 schema 定義檔案（schema.sql）
  - 設定開發環境的 Miniflare 配置
  - _需求：5.1, 5.2, 5.3, 5.4, 5.5_

- [ ] 2. 實作 D1 資料庫 schema 和初始化
  - 撰寫 SQL schema 定義（responses 資料表）
  - 建立必要的索引（timestamp, phone+timestamp, region, occupation）
  - 撰寫資料庫初始化腳本
  - _需求：5.2, 5.3, 5.4, 5.5_

- [ ] 2.1 撰寫 schema 驗證測試
  - 測試資料表結構正確性
  - 測試索引存在性
  - 測試約束條件（NOT NULL）
  - _需求：5.2, 5.3, 5.4, 5.5_

- [ ] 3. 實作 Cloudflare Worker API 端點
  - 建立 Worker 入口檔案和路由處理
  - 實作 POST /api/responses 端點（建立回應記錄）
  - 實作 GET /api/responses 端點（取得所有回應記錄）
  - 實作 GET /api/export 端點（匯出 CSV，需密碼驗證）
  - 設定 CORS 標頭
  - _需求：2.1, 2.2, 2.5, 6.1, 6.2, 6.3_

- [ ] 3.1 實作 API 輸入驗證
  - 建立驗證函數（重用現有 Validator 邏輯）
  - 驗證回應記錄欄位（name, phone, region, occupation, timestamp）
  - 返回適當的錯誤訊息
  - _需求：2.3_

- [ ] 3.2 撰寫屬性測試：無效資料拒絕
  - **Property 3: 無效資料拒絕**
  - **驗證：需求 2.3**
  - 生成各種無效回應記錄
  - 驗證 API 拒絕並返回錯誤
  - _需求：2.3_

- [ ] 3.3 實作 API 錯誤處理
  - 處理資料庫錯誤並返回適當的 HTTP 狀態碼
  - 處理驗證錯誤並返回詳細錯誤訊息
  - 記錄錯誤到 Cloudflare Workers 日誌
  - _需求：2.4_

- [ ] 3.4 實作認證機制
  - 驗證下載請求的密碼參數
  - 返回 401 狀態碼給無效認證
  - 確保認證失敗時不暴露資料
  - _需求：6.1, 6.2, 6.3, 6.4_

- [ ] 3.5 撰寫屬性測試：認證失敗拒絕
  - **Property 8: 認證失敗拒絕**
  - **驗證：需求 6.3**
  - 生成各種無效密碼
  - 驗證返回 401 狀態碼
  - _需求：6.3_

- [ ] 3.6 撰寫單元測試：API 端點
  - 測試 POST /api/responses 成功案例
  - 測試 GET /api/responses 成功案例
  - 測試 GET /api/export 認證成功案例
  - 測試 CORS 標頭設定
  - _需求：2.1, 2.2, 2.5, 6.2_

- [ ] 4. 實作資料庫操作層
  - 建立資料庫連線管理函數
  - 實作插入回應記錄函數
  - 實作查詢所有回應記錄函數
  - 實作重複檢測查詢函數
  - _需求：1.1, 1.2, 1.3, 3.5_

- [ ] 4.1 撰寫屬性測試：回應記錄插入完整性
  - **Property 1: 回應記錄插入完整性**
  - **驗證：需求 1.2, 2.1**
  - 生成隨機有效回應記錄
  - 插入後檢索並驗證欄位值
  - _需求：1.2, 2.1_

- [ ] 4.2 撰寫屬性測試：回應記錄檢索完整性
  - **Property 2: 回應記錄檢索完整性**
  - **驗證：需求 1.3, 2.2**
  - 生成隨機數量的回應記錄
  - 批次插入後檢索並驗證
  - _需求：1.3, 2.2_

- [ ] 5. 實作前端 API 客戶端
  - 建立 D1ApiClient 類別（src/D1ApiClient.js）
  - 實作 createResponse 方法（POST 請求）
  - 實作 getAllResponses 方法（GET 請求）
  - 實作 exportCSV 方法（GET 請求帶密碼）
  - 實作錯誤處理和重試邏輯
  - _需求：7.2, 7.3, 7.4_

- [ ] 5.1 撰寫屬性測試：API 錯誤處理
  - **Property 9: API 錯誤處理**
  - **驗證：需求 7.4**
  - 模擬各種 API 錯誤情況
  - 驗證顯示適當錯誤訊息
  - _需求：7.4_

- [ ] 5.2 撰寫單元測試：D1ApiClient
  - 測試 createResponse 請求建構
  - 測試 getAllResponses 回應處理
  - 測試 exportCSV 密碼傳遞
  - 測試網路錯誤處理
  - _需求：7.2, 7.3, 7.4_

- [ ] 6. 實作資料遷移工具
  - 建立 MigrationTool 類別（src/MigrationTool.js）
  - 實作從 localStorage 讀取資料
  - 實作資料驗證邏輯
  - 實作重複檢測邏輯（基於 phone + timestamp）
  - 實作批次上傳到 D1
  - 實作遷移結果摘要
  - _需求：3.1, 3.2, 3.3, 3.4, 3.5_

- [ ] 6.1 撰寫屬性測試：遷移資料驗證
  - **Property 4: 遷移資料驗證**
  - **驗證：需求 3.2, 3.3**
  - 生成混合有效和無效記錄
  - 驗證只有有效記錄被插入
  - _需求：3.2, 3.3_

- [ ] 6.2 撰寫屬性測試：重複記錄檢測
  - **Property 5: 重複記錄檢測**
  - **驗證：需求 3.5**
  - 生成包含重複的記錄集
  - 驗證重複記錄被跳過
  - _需求：3.5_

- [ ] 6.3 撰寫單元測試：MigrationTool
  - 測試 localStorage 讀取
  - 測試遷移結果摘要格式
  - 測試錯誤記錄收集
  - _需求：3.1, 3.4_

- [ ] 7. 更新 CSV 匯出功能以支援 D1
  - 更新 CSVManager.toCSV 以接受從 API 取得的資料
  - 確保 UTF-8 BOM 正確添加
  - 確保特殊字元正確轉義
  - 更新下載功能以使用 API 資料
  - _需求：4.1, 4.2, 4.3, 4.4, 4.5_

- [ ] 7.1 撰寫屬性測試：CSV 轉換往返一致性
  - **Property 6: CSV 轉換往返一致性**
  - **驗證：需求 4.1, 4.2**
  - 生成隨機回應記錄集
  - 轉換為 CSV 再解析回來
  - 驗證資料等價
  - _需求：4.1, 4.2_

- [ ] 7.2 撰寫屬性測試：CSV 特殊字元轉義
  - **Property 7: CSV 特殊字元轉義**
  - **驗證：需求 4.4**
  - 生成包含特殊字元的記錄
  - 轉換為 CSV 再解析
  - 驗證特殊字元正確保留
  - _需求：4.4_

- [ ] 7.3 撰寫單元測試：CSV 功能
  - 測試 UTF-8 BOM 添加
  - 測試檔案名稱時間戳記格式
  - _需求：4.3, 4.5_

- [ ] 8. 更新前端元件以使用 API
  - 更新 main.js 初始化 D1ApiClient
  - 更新 SurveyForm 提交處理以使用 API
  - 更新 StatisticsPanel 以從 API 載入資料
  - 添加載入指示器（loading indicators）
  - 添加錯誤訊息顯示
  - _需求：7.1, 7.2, 7.3, 7.5_

- [ ] 8.1 撰寫單元測試：前端元件整合
  - 測試表單提交觸發 API 呼叫
  - 測試統計面板觸發 API 呼叫
  - 測試載入指示器顯示
  - 測試錯誤訊息顯示
  - _需求：7.2, 7.3, 7.5_

- [ ] 9. 建立遷移 UI 介面
  - 在 index.html 添加遷移按鈕（僅管理員可見）
  - 實作遷移進度顯示
  - 實作遷移結果摘要顯示
  - 添加確認對話框
  - _需求：3.4_

- [ ] 10. 更新部署配置
  - 更新 wrangler.toml 設定生產環境綁定
  - 建立 D1 資料庫部署腳本
  - 更新 DEPLOYMENT.md 文件
  - 建立環境變數設定指南
  - _需求：1.1_

- [ ] 11. 檢查點 - 確保所有測試通過
  - 確保所有測試通過，如有問題請詢問使用者

- [ ] 12. 建立開發和測試文件
  - 撰寫 API 使用文件
  - 撰寫遷移工具使用指南
  - 更新 README.md 包含 D1 設定說明
  - 建立故障排除指南
  - _需求：所有_
